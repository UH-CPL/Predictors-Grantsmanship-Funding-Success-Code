---
title: "Descriptive Statistics"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(freqtables)
library(plotrix)
library(plotly)
library(tools)
library(plotrix)
library(plotly)
library(grid)
library(gridExtra)
library(ggpubr)
library(cowplot)
library(reshape2)
library(plyr)
library(ggplot2)
library(dplyr)
library(plotrix)
library(plotly)
library(grid)
library(gridExtra)
library(ggpubr)
library(cowplot)
library(reshape2)
library(plyr)
library(ggplot2)
library(ggrepel)
library(forcats)
library(scales)
library(stringr)
```


```{r, echo=FALSE}
root_dir <- getwd()
project_directory <- dirname(root_dir)
data_dir <- file.path(project_directory, 'curated-data')
plot_dir <- file.path(project_directory, 'Plots')
data_file_name <- 'Selected_coreQuestions.csv'
curated_data_dir <- file.path(project_directory, 'curated-data')
Data <-
  read.csv(file.path(data_dir, data_file_name), stringsAsFactors = FALSE)
```

```{r, echo=FALSE}

Data <- Data[,c("FR", "Gender", "Departmnet", "State", "TW_W_H", "TW_Research", "RO_F_EG")]

# count(Data$FR)
Data <- Data %>%
  mutate(FR = recode(FR, "Assistant Professor" = "FR1", "Associate Professor" = "FR2", "Professor" = "FR3" ))
# count(Data$State)

Data$TW_Research <- as.factor(Data$TW_Research)


Data <- Data %>%
  mutate(TWR = recode(TW_Research, "0" = "0-20", "10" = "0-20", "20" = "0-20", "70" = "70-90", "80" = "70-90",  "90" = "70-90")) %>% 
  mutate(EG = recode(RO_F_EG, "1-25%" = "1-25", "25-50%" = "25-50", "50-75%" = "50-75", "75-100%" = "75-100", "Fully funded" = "FF",  "Not funded" = "NF"))

```


```{r, echo=FALSE}
Natural_Sciences = '^Applied Math$|^Chemistry and Biochemistry$|^Oceanography$|^Environmental Studies$|^Chemistry$|^Physics$|^Geosciences$|^Mathematics$'
# Biomedical_Science ='^Health$|^Health and Human Performance$|^HHP$'
CIS = '^Informatics$|^Information$|^Information and Logistics Technology$|^Information Science$|^Computer Science$|^Scientific Computing$'
Engineering = '^Engineering / Learning Sciences$|^Management$|^Statistical Sciences and Operations Research$|^Technology$|^Engineering$'
Biomedical_Sciences = '^Health$|^Health and Human Performance$|^HHP$|^Neurobiology$|^Neuroscience$|^Optometry$|^Pharmacological and Pharmaceutical Sciences$|^Pharmacy$|^Vision Science$|^Biology$|^Medicine$|^Pharmacy $'
Behavioral_Sciences = '^Political Science$|^Sociology$|^Psychology$|^Speech, Language, and Hearing$|^Political Science $'





Data <- Data %>%
  mutate(
    Disciplines = case_when(
      # str_detect(Departmnet, Natural_Sciences) ~ 'Natural Sciences',
      str_detect(Departmnet, Natural_Sciences) ~ 'NAT',
      # str_detect(Departmnet, CIS) ~ 'Computer & Information Sciences',
      str_detect(Departmnet, CIS) ~ 'CIS',
      # str_detect(Departmnet, Engineering) ~ 'Engineering',
      str_detect(Departmnet, Engineering) ~ 'ENG',
      # str_detect(Departmnet, Biomedical_Sciences) ~ 'Biomedical Sciences',
      str_detect(Departmnet, Biomedical_Sciences) ~ 'BIO',
      # str_detect(Departmnet, Behavioral_Sciences) ~ 'Behavioral Sciences'
      str_detect(Departmnet, Behavioral_Sciences) ~ 'BEHAV'
    )
  )

```



```{r, echo=FALSE}
# colnames(Data)
core_plot_df <- Data[,c("Disciplines", "State", "TW_W_H", "TWR", "EG")]
```



```{r, echo=FALSE}
list0 = c("BIO", "BEHAV", "ENG", "CIS", "NAT")
list1 = c("East", "West", "Midwest", "South")
list2 = c("< 30", "30-40", "40-50", "> 50")
list3 = c("0-20", "30", "40", "50", "60", "70-90")
list4 = c("NF",
          "1-25",
          "25-50",
          "50-75",
          "75-100",
          "FF")
Ticks_list <-
  list(list0,
       list1,
       list2,
       list3,
       list4)
title_list <- c("Disciplinary Distribution", "Geographic Distribution", "Weekly Workload [hrs]",  "Research Load [%]", "Funding Coverage [%]")
```



```{r, echo=FALSE}
percent <- function(x, digits = 0, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}
```


```{r, echo=FALSE, warning=FALSE}


plot_list <- list()

FR_Gender <- Data[, c("FR", "Gender")]

percentage_table <- ddply(data.frame(table(FR_Gender)), .(Gender))
percentage_table <-
  percentage_table %>% mutate(prop = (Freq / sum(Freq)))

percentage_table$percent <- percent((percentage_table$prop)) 
  
Gender_FR <-
  ggplot(percentage_table, aes(x = Gender, y = Freq, fill = Gender)) + geom_bar(stat = "identity") +
  facet_grid( ~ FR) +
  geom_text(
    aes(y = Freq, label = percent),
    vjust = -0.10,
    color = "black",
    size = 2.5,
    face = "bold"
  ) +
  theme(
    axis.title.y = element_text(
      size = 8,
      face = "bold",
      colour = "black"
    ),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position = 'none',
    plot.title = element_text(hjust = 0.5, size = 10),
    axis.text.x = element_text(face = "bold", size = 7),
    axis.text.y = element_text(face = "bold", size = 7),
    strip.text = element_text(size = 6, face = "bold")
  ) +
  labs(x = "", y = "Count", title = "Gender per Faculty Rank")
# Gender_FR

 
plot_list[[length(plot_list) + 1]] <- Gender_FR
```



```{r, echo=FALSE, warning=FALSE}


for (i in 1:length(core_plot_df)) {
  y_title = ""
  if (title_list[i] == "Weekly Workload [hrs]") {
    y_title = "Count"
  }


  if (i < 3) {
    ylimit = 200
  } else if (i == 3) {
    ylimit = 250
  } else {
    ylimit = 100
  }


  temp <- count(core_plot_df[i])
  colnames(temp) <- c("item", "count")
  temp <- temp[!(temp$item == ""),]
  temp <- temp[order(temp$count), ]
  temp <- temp %>% mutate(prop = (count / sum(count))) 
  temp$percentage <- percent((temp$prop))


  bar_plot <- ggplot(data = temp, aes(x = item, y = count)) +
    geom_bar(stat = "identity",
             width = 0.5,
             fill = "steelblue") +
    geom_text(
      aes(label = percentage),
      # vjust = 0.5,
      vjust = -0.25,
      color = "black",
      # angle = 90,
      size = 2.5,
      face = "bold"
    ) +
    theme_bw() +
    scale_y_continuous(breaks = seq(0, ylimit, by = 50),
                       limits = c(0, ylimit)) +
    labs(x = "", y = y_title, title = title_list[i]) +
    theme(
      axis.title.y = element_text(
        size = 8,
        face = "bold",
        colour = "black"
      ),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0.5, size = 10),
      axis.text.x = element_text(face = "bold", size = 7),
      axis.text.y = element_text(face = "bold", size = 7)
    ) + scale_x_discrete(limits = Ticks_list[[i]])
  # print(bar_plot)

  plot_list[[length(plot_list) + 1]] <- bar_plot

}


final_plot <- ggarrange(plotlist = plot_list,
                        nrow = 2,
                        ncol = 3)
# filename <- "Figure1_without_percentage.pdf"
filename <- "Figure1_with_percentage.pdf"
full_path <- file.path(plot_dir, filename)
ggsave(
  full_path,
  final_plot,
  width = 8.5,
  height = 5.5,
  units = "in"
)

```


```{r, echo=FALSE, warning=FALSE}
library(superml)

# FR1 <- FR_Gender %>% filter(FR == "FR1")
# 
# print(
#   "=======================FR1 or Assistant Professo================================"
# )
# print(FR1 %>% freq_table(FR1[2]))
# 
# print(
#   "=======================FR2 or Associate Professor==============================="
# )
# 
# FR2 <- FR_Gender %>% filter(FR == "FR2")
# 
# print(FR2 %>% freq_table(FR2[2]))
# 
# 
# print(
#   "=======================FR3 or Professor========================================"
# )
# FR3 <- FR_Gender %>% filter(FR == "FR3")
# print(FR3 %>% freq_table(FR3[2]))


core_plot_df$FR <- Data$FR
core_plot_df$Gender <- Data$Gender
title_list <- c("Faculty Rank", "Gender", "Disciplinary Distribution", "Geographic Distribution", "Weekly Workload [hrs]",  "Research Load [%]", "Funding Coverage [%]")


core_plot_df = core_plot_df[,c("FR", "Gender", "Disciplines", "State", "TW_W_H", "TWR", "EG")]

for (i in 1:length(core_plot_df)) {
  print(paste("========================", title_list[i],"========================"))
  print(core_plot_df %>%
          freq_table(core_plot_df[i]))

}
```







